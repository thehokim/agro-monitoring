name: Blue-Green Deploy Project2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v3

      - name: üõ† Build Docker image
        run: docker build -t thehokim/project2:latest .

      - name: üöÄ Push Docker image
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push thehokim/project2:latest

      - name: üîç Determine active version
        id: active
        run: |
          if docker ps --format '{{.Names}}' | grep -q project2_blue; then
            echo "ACTIVE=blue" >> $GITHUB_ENV
          else
            echo "ACTIVE=green" >> $GITHUB_ENV
          fi

      - name: üöÄ Run new container
        run: |
          echo "üîÅ Current active version: ${{ env.ACTIVE }}"
          if [ "${{ env.ACTIVE }}" == "blue" ]; then
            docker rm -f project2_green || true
            docker run -d --name project2_green -p 8201:8080 thehokim/project2:latest
          else
            docker rm -f project2_blue || true
            docker run -d --name project2_blue -p 8202:8080 thehokim/project2:latest
          fi

      - name: üîÅ Switch NGINX config (project2)
        run: |
          if [ "${{ env.ACTIVE }}" == "blue" ]; then
            sudo sed -i 's/server 127.0.0.1:8201;/# server 127.0.0.1:8201;\nserver 127.0.0.1:8202;/' /etc/nginx/sites-available/project2.conf
          else
            sudo sed -i 's/server 127.0.0.1:8202;/# server 127.0.0.1:8202;\nserver 127.0.0.1:8201;/' /etc/nginx/sites-available/project2.conf
          fi
          sudo systemctl reload nginx

      - name: üßπ Remove old version
        run: |
          if [ "${{ env.ACTIVE }}" == "blue" ]; then
            if docker ps -a --format '{{.Names}}' | grep -q project2_blue; then
              docker stop project2_blue
              docker rm project2_blue
            fi
          else
            if docker ps -a --format '{{.Names}}' | grep -q project2_green; then
              docker stop project2_green
              docker rm project2_green
            fi
          fi
